{% extends "base.html" %}
{% block title %}Your Collections{% endblock %}
{% block css %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('css', filename='DataTables/css/jquery.dataTables.css') }}" />
    <link rel="stylesheet" type="text/css" href="{{ url_for('js', filename='DataTablesExtensions/buttonsBootstrap/css/buttons.bootstrap.css') }}" />
    <link rel="stylesheet" type="text/css" href="/static/new/css/show_trait.css" />
{% endblock %}
{% block content %}
<!-- Start of body -->
    <div class="container">
        {% if g.user_session.logged_in %}
        <h1>Collections owned by {% if g.user_session.user_name %}{{ g.user_session.user_name }}{% else %}{{ g.user_session.user_email }} {% endif %}</h1>
        {% else %}
        <h1>Your Collections</h1>
        {% endif %}

        <div>
            <form id="collections_form" action="/delete" method="post">
              <input type="hidden" name="uc_id" id="uc_id" value="" />
            </form>
            <button class="btn btn-default" id="select_all"><span class="glyphicon glyphicon-ok"></span> Select All</button>
            <button class="btn btn-default" id="deselect_all"><span class="glyphicon glyphicon-remove"></span> Deselect All</button>
            <button class="btn btn-default" id="invert"><span class="glyphicon glyphicon-resize-vertical"></span> Invert</button>
            <button class="btn btn-danger" id="remove_collections" data-url="/collections/delete">Remove Collections</button>
            <input type="text" id="searchbox" class="form-control" style="width: 200px; display: inline;" placeholder="Search This Table For ...">
            <input type="text" id="select_top" class="form-control" style="width: 200px; display: inline;" placeholder="Select Top ...">
        </div>
        <br>
        <div id="collections_list" style="width:50%; margin-top: 20px; margin-bottom: 20px;">
        {% if collections|length > 0 %}
        <table class="table-hover table-striped cell-border" id='trait_table' style="float: left;">
            <thead>
                <tr>
                    <th></th>
                    <th>Index</th>
                    <th>Name</th>
                    <th>Created</th>
                    <th>Last Changed</th>
                    <th># Records</th>
                </tr>
            </thead>

            <tbody>
            {% for uc in collections %}
                {% if uc.num_members > 0 %}
                <tr class="collection_line">
                    <td align="center" style="padding: 0px;"><INPUT TYPE="checkbox" NAME="collection" class="checkbox trait_checkbox" VALUE="{{ uc.id }}"></td>
                    <td align="right">{{ loop.index }}
                    <td><a class="collection_name" href="{{ url_for('view_collection', uc_id=uc.id) }}">{{ uc.name }}</a></td>
                    <td>{{ uc.created_timestamp }}</td>
                    <td>{{ uc.changed_timestamp }}</td>
                    <td align="right">{{ uc.num_members }}</td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        You have no collections yet.
        {% endif %}
        </div>
    </div>

<!-- End of body -->

{% endblock %}

{% block js %}
    <script language="javascript" type="text/javascript" src="{{ url_for('js', filename='js_alt/timeago.min.js') }}"></script>
    <script type="text/javascript" src="/static/new/javascript/search_results.js"></script>
    <script language="javascript" type="text/javascript" src="{{ url_for('js', filename='DataTables/js/jquery.dataTables.min.js') }}"></script>
    <script language="javascript" type="text/javascript" src="{{ url_for('js', filename='jszip/jszip.min.js') }}"></script>
    <script language="javascript" type="text/javascript" src="{{ url_for('js', filename='DataTablesExtensions/plugins/sorting/natural.js') }}"></script>
    <script language="javascript" type="text/javascript" src="{{ url_for('js', filename='DataTablesExtensions/buttons/js/dataTables.buttons.min.js') }}"></script>
    <script>
            $('#trait_table').dataTable( {
                "drawCallback": function( settings ) {
                     $('#trait_table tr').click(function(event) {
                        if (event.target.type !== 'checkbox' && event.target.tagName.toLowerCase() !== 'a') {
                          var obj =$(this).find('input');
                          obj.prop('checked', !obj.is(':checked'));
                        }
                        if ($(this).hasClass("selected") && event.target.tagName.toLowerCase() !== 'a'){
                          $(this).removeClass("selected")
                        } else if (event.target.tagName.toLowerCase() !== 'a') {
                          $(this).addClass("selected")
                        }
                     });
                },
                "buttons": [ 'copy', 'csv', 'excel' ],
                "columns": [
                    { "type": "natural", "width": "3%" },
                    { "type": "natural", "width": "8%" },
                    { "type": "natural", "width": "20%" },
                    { "type": "natural", "width": "25%" },
                    { "type": "natural", "width": "25%" },
                    { "type": "natural", "width": "15%" }
                ],
                "columnDefs": [ {
                    "targets": 0,
                    "orderable": false
                } ],
                "order": [[1, "asc" ]],
                "sDom": "BZtr",
                "iDisplayLength": -1,
                "autoWidth": false,
                "bDeferRender": true,
                "bSortClasses": false,
                "scrollCollapse": true,
                "paging": false,
                "orderClasses": true
            } );

            submit_special = function(url) {
                $("#collections_form").attr("action", url);
                return $("#collections_form").submit();
            };

            $("#remove_collections").on("click", function() {
                url = $(this).data("url")
                collections = []
                $(".trait_checkbox:checked").each(function() {
                    collections.push($(this).val());
                });
                collections_string = collections.join(":")
                $("input[name=uc_id]").val(collections_string)
                return submit_special(url)
            });


    </script>
{% endblock %}
